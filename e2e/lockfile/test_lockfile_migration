#!/usr/bin/env bash

export MISE_LOCKFILE=1
export MISE_EXPERIMENTAL=1

# Test legacy format migration
cat <<EOF >mise.lock
[tools.tiny]
version = "1.0.0"
backend = "asdf:tiny"

[tools.tiny.checksums]
"tiny-1.0.0-linux-x64.tar.gz" = "sha256:abc123"

[tools.tiny.sizes]
"tiny-1.0.0-linux-x64.tar.gz" = 1024
EOF

echo "Legacy format lockfile:"
cat mise.lock

# This should trigger migration when the lockfile is read
mise ls

echo "After migration:"
cat mise.lock

# Should now have assets section
assert_contains "cat mise.lock" "[assets]"
assert_contains "cat mise.lock" 'checksum = "sha256:abc123"'
assert_contains "cat mise.lock" 'size = 1024'

# Should not have the old format
assert_not_contains "cat mise.lock" "[tools.tiny.checksums]"
assert_not_contains "cat mise.lock" "[tools.tiny.sizes]"

echo "Migration test passed!"