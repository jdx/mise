#!/usr/bin/env bash

# Test that env cache is NOT used when secrets/redactions are present

export MISE_EXPERIMENTAL=true
export MISE_ENV_CACHE=true

# Clear any existing cache first
rm -rf "$MISE_STATE_DIR/env-cache/"

# Create a config with a redacted secret
cat <<'EOF' >mise.toml
[env]
MY_SECRET = { value = "secret-value", redact = true }
EOF

# First call computes env
mise env >/dev/null

# Check that no cache file was created (or it was skipped)
# We verify by checking trace output shows no cache save
output=$(MISE_TRACE=1 mise env 2>&1)

# Should NOT see "using cached environment" since secrets prevent caching
assert_not_contains "echo '$output'" "using cached environment"

# Now test without redaction - cache SHOULD work
cat <<'EOF' >mise.toml
[env]
NOT_SECRET = "plain-value"
EOF

# Clear any existing cache
rm -rf "$MISE_STATE_DIR/env-cache/"

# First call computes and caches
mise env >/dev/null

# Second call should use cache
output=$(MISE_TRACE=1 mise env 2>&1)
assert_contains "echo '$output'" "using cached environment"
