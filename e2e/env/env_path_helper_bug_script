#!/usr/bin/env zsh
# shellcheck disable=SC1071
set -eu

# Verifies that _.path works when path_helper runs after mise activation

mkdir -p homebrew/bin system/bin

cat > homebrew/bin/tool <<'EOF'
#!/usr/bin/env bash
echo "homebrew-tool"
EOF
chmod +x homebrew/bin/tool

cat > system/bin/tool <<'EOF'
#!/usr/bin/env bash
echo "system-tool"
EOF
chmod +x system/bin/tool

cat > .mise.toml <<'EOF'
[env]
_.path = ["homebrew/bin"]
EOF

# Activate mise
eval "$(mise activate zsh --status)"
_mise_hook

# Verify initial state works
test "$(tool)" = "homebrew-tool" || exit 1

# Simulate path_helper prepending system paths (like /etc/zprofile does)
export PATH="$PWD/system/bin:/usr/bin:/bin:$PATH"

# After path_helper runs, system tool is found first (the bug)
test "$(tool)" = "system-tool" || exit 1

# Call _mise_hook again - should re-prioritize _.path (the fix)
_mise_hook

# Verify fix: homebrew tool should now be found first again
test "$(tool)" = "homebrew-tool" || exit 1

rm -rf homebrew system .mise.toml
