#!/usr/bin/env zsh
# shellcheck disable=SC1071
set -eu

# Verifies that _.path works when path_helper runs after mise activation

mkdir -p homebrew/bin system/bin

cat > homebrew/bin/tool <<'EOF'
#!/usr/bin/env bash
echo "homebrew-tool"
EOF
chmod +x homebrew/bin/tool

cat > system/bin/tool <<'EOF'
#!/usr/bin/env bash
echo "system-tool"
EOF
chmod +x system/bin/tool

cat > .mise.toml <<'EOF'
[env]
_.path = ["homebrew/bin"]
EOF

# Activate mise (sets __MISE_ZSH_PRECMD_RUN=0)
eval "$(mise activate zsh --status)"

# Simulate path_helper prepending system paths (like /etc/zprofile does)
# This happens before the first precmd/prompt
export PATH="$PWD/system/bin:/usr/bin:/bin:$PATH"

# After path_helper runs, system tool is found first (the bug)
test "$(tool)" = "system-tool" || exit 1

# First precmd triggers _mise_hook with reason=precmd and __MISE_ZSH_PRECMD_RUN=0
# This should re-prioritize _.path (the fix)
_mise_hook precmd

# Verify fix: homebrew tool should now be found first again
test "$(tool)" = "homebrew-tool" || exit 1

rm -rf homebrew system .mise.toml
