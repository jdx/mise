#!/usr/bin/env bash

# Test that env cache is NOT used when templates are present
# Templates are dynamic (e.g., now(), uuid()) and should not be cached

export MISE_EXPERIMENTAL=true
export MISE_ENV_CACHE=true

# Clear any existing cache first
rm -rf "$MISE_STATE_DIR/env-cache/"

# Create a config with a template
cat <<'EOF' >mise.toml
[env]
TEMPLATE_VAR = "{{ env.HOME }}/test"
EOF

# First call computes env
mise env >/dev/null

# Check that cache is NOT used (templates prevent caching)
output=$(MISE_TRACE=1 mise env 2>&1)
assert_not_contains "echo '$output'" "using cached environment"

# Verify the template was evaluated correctly
output=$(mise env)
assert_contains "echo '$output'" "TEMPLATE_VAR="

# Now test without templates - cache SHOULD work
cat <<'EOF' >mise.toml
[env]
STATIC_VAR = "plain-value"
EOF

rm -rf "$MISE_STATE_DIR/env-cache/"

# First call caches
mise env >/dev/null

# Second call should use cache
output=$(MISE_TRACE=1 mise env 2>&1)
assert_contains "echo '$output'" "using cached environment"
