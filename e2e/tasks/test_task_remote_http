#!/usr/bin/env bash

#################################################################################
# Setup
#################################################################################

REMOTE_TASKS_DIR="${MISE_CACHE_DIR}/remote-http-tasks-cache"

# Create a simple remote task script to be served over HTTP
cat > remote_task.sh <<'EOF'
#!/usr/bin/env bash
echo "REMOTE_HTTP_TASK_EXECUTED"
EOF
chmod +x remote_task.sh

# Start a local HTTP server on an ephemeral port serving current directory
python3 -m http.server 0 > server.log 2>&1 &
SERVER_PID=$!

cleanup() {
  kill "$SERVER_PID" 2>/dev/null || true
}
trap cleanup EXIT

# Wait for server to start and capture port
wait_for_server() {
  local max_attempts=30
  local attempt=1
  while [ $attempt -le $max_attempts ]; do
    if grep -q "Serving HTTP on" server.log; then
      return 0
    fi
    sleep 1
    attempt=$((attempt + 1))
  done
  echo "ERROR: HTTP server failed to start within timeout" >&2
  exit 1
}

wait_for_server
PORT=$(grep -m1 -oE 'port [0-9]+' server.log | awk '{print $2}')
[ -n "$PORT" ] || { echo "Failed to determine HTTP server port" >&2; exit 1; }
REMOTE_URL="http://localhost:${PORT}/remote_task.sh"

#################################################################################
# Define task using remote HTTP file
#################################################################################

cat > mise.toml <<EOF
[tasks.remote_http_task]
file = "${REMOTE_URL}"
EOF

assert_contains "mise tasks" "remote_http_task"

#################################################################################
# Initial run should download and cache
#################################################################################

assert_succeed "mise run remote_http_task"
assert_directory_exists "${REMOTE_TASKS_DIR}"
assert_directory_not_empty "${REMOTE_TASKS_DIR}"

mise cache clear

#################################################################################
# Run with env var disabling cache
#################################################################################

assert_succeed "MISE_TASK_REMOTE_NO_CACHE=true mise run remote_http_task"
assert_directory_not_exists "${REMOTE_TASKS_DIR}"

#################################################################################
# Run with --no-cache flag
#################################################################################

assert_succeed "mise run remote_http_task --no-cache"
assert_directory_not_exists "${REMOTE_TASKS_DIR}"

#################################################################################
# Normal run again should recreate cache
#################################################################################

assert_succeed "mise run remote_http_task"
assert_directory_exists "${REMOTE_TASKS_DIR}"
assert_directory_not_empty "${REMOTE_TASKS_DIR}"

