#!/usr/bin/env bash
# Test per-task inherit=false setting

# Create parent directory with tasks
mkdir -p parent/child

cat <<EOF >parent/mise.toml
[tasks.shared-task]
run = "echo shared"

[tasks.private-task]
run = "echo private"
inherit = false
EOF

cat <<EOF >parent/child/mise.toml
[tasks.child-task]
run = "echo child"
EOF

# In parent directory, both tasks should be visible
cd parent
assert_contains "mise tasks" "shared-task"
assert_contains "mise tasks" "private-task"

# In child directory, shared-task should be visible but private-task should NOT
cd child
assert_contains "mise tasks" "shared-task"
assert_contains "mise tasks" "child-task"

# private-task with inherit=false should NOT be visible in child
if mise tasks 2>&1 | grep -q "private-task"; then
	fail "private-task should not be visible in child directory (inherit=false)"
else
	ok "private-task correctly hidden from child directory"
fi

# Test file-based task with inherit=false
cd ..
mkdir -p mise-tasks
cat <<'EOF' >mise-tasks/shared-file-task
#!/bin/bash
#MISE description="Shared file task"
echo "shared file task"
EOF
chmod +x mise-tasks/shared-file-task

cat <<'EOF' >mise-tasks/private-file-task
#!/bin/bash
#MISE description="Private file task"
#MISE inherit=false
echo "private file task"
EOF
chmod +x mise-tasks/private-file-task

# In parent, both file tasks should be visible
assert_contains "mise tasks" "shared-file-task"
assert_contains "mise tasks" "private-file-task"

# In child, shared-file-task should be visible but private-file-task should NOT
cd child
assert_contains "mise tasks" "shared-file-task"

if mise tasks 2>&1 | grep -q "private-file-task"; then
    fail "private-file-task should not be visible in child directory (inherit=false)"
else
    ok "private-file-task correctly hidden from child directory"
fi
