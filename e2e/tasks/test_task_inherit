#!/usr/bin/env bash
# Test per-task inherit=false setting

# Create parent directory with tasks
mkdir -p parent/child parent/mise-tasks

cat <<EOF >parent/mise.toml
[tasks.shared-task]
run = "echo shared"

[tasks.private-task]
run = "echo private"
inherit = false
EOF

cat <<EOF >parent/child/mise.toml
[tasks.child-task]
run = "echo child"
EOF

# Create file-based tasks in parent
cat <<'EOF' >parent/mise-tasks/shared-file-task
#!/bin/bash
#MISE description="Shared file task"
echo "shared file task"
EOF
chmod +x parent/mise-tasks/shared-file-task

cat <<'EOF' >parent/mise-tasks/private-file-task
#!/bin/bash
#MISE description="Private file task"
#MISE inherit=false
echo "private file task"
EOF
chmod +x parent/mise-tasks/private-file-task

# In parent directory, all tasks should be visible
cd parent
assert_contains "mise tasks" "shared-task"
assert_contains "mise tasks" "private-task"
assert_contains "mise tasks" "shared-file-task"
assert_contains "mise tasks" "private-file-task"

# In child directory, shared tasks should be visible but private tasks should NOT
cd child
assert_contains "mise tasks" "shared-task"
assert_contains "mise tasks" "child-task"
assert_contains "mise tasks" "shared-file-task"

# private-task with inherit=false should NOT be visible in child
if mise tasks 2>&1 | grep -q "private-task"; then
	fail "private-task should not be visible in child directory (inherit=false)"
else
	ok "private-task correctly hidden from child directory"
fi

# private-file-task with inherit=false should NOT be visible in child
if mise tasks 2>&1 | grep -q "private-file-task"; then
	fail "private-file-task should not be visible in child directory (inherit=false)"
else
	ok "private-file-task correctly hidden from child directory"
fi
