#!/usr/bin/env bash

# Test HTTP backend with version_list_url (using claude-code from registry)
#
# This is intentionally a "fast" test (no binary download); install coverage for the
# http backend is handled in other `e2e/backend/test_http*` tests.

# Ensure this exercises the registry `version_list_url` directly (not versions host cache)
export MISE_USE_VERSIONS_HOST=0

# Test that ls-remote works with version_list_url
assert_contains "mise ls-remote claude" "2."

# Test that `mise latest` returns a valid 2.1.x version
# Note: We can't assert exact match with GCS /latest because aqua gets versions from
# GitHub tags which may lag behind GCS releases (e.g., 2.1.29 in GCS but only 2.1.27 tagged)
MISE_LATEST="$(mise latest claude)"
if [[ ! $MISE_LATEST =~ ^2\.1\.[0-9]+ ]]; then
	fail "mise latest claude returned unexpected value: '$MISE_LATEST' (expected 2.1.x)"
fi

# Test that ls-remote works without registry or installed tool
cat <<EOF >mise.toml
[tools."http:zmx"]
version = "0.2.0"
version_list_url = "https://api.github.com/repos/neurosnap/zmx/tags"
version_json_path = ".[].name"
url = "https://zmx.sh/a/zmx-{{version}}-{{os()}}-{% if arch() == 'arm64' %}aarch64{% else %}x86_64{% endif %}.tar.gz"
EOF

mise cache clear
assert_contains "mise ls-remote http:zmx" "0.2.0"
