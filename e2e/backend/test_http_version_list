#!/usr/bin/env bash

# Test HTTP backend with version_list_url (using claude-code from registry)
#
# This is intentionally a "fast" test (no binary download); install coverage for the
# http backend is handled in other `e2e/backend/test_http*` tests.

# Ensure this exercises the registry `version_list_url` directly (not versions host cache)
export MISE_USE_VERSIONS_HOST=0

# Test that ls-remote works with version_list_url
assert_contains "mise ls-remote claude" "2."

# Test that `mise latest` matches upstream `/latest` (regression for stale `/stable`)
LATEST="$(curl -fsSL https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/latest | tr -d '\r\n')"
if [[ -z ${LATEST//[[:space:]]/} ]]; then
	fail "upstream claude-code /latest returned empty response"
fi
if [[ ! $LATEST =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
	fail "upstream claude-code /latest returned unexpected value: '$LATEST'"
fi
assert "mise latest claude" "$LATEST"
