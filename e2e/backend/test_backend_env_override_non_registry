#!/usr/bin/env bash
set -euo pipefail

# Test MISE_BACKENDS_* environment variable override for non-registry tools

# Clean up any existing installations
mise uninstall --all github:casey/just 2>/dev/null || true
mise uninstall --all just-test 2>/dev/null || true

# Test 1: Non-registry tool with custom backend via env var
echo "Testing non-registry tool with env override..."
export MISE_BACKENDS_JUST_TEST='github:casey/just'

# Try to list remote versions - should use GitHub backend
echo "Listing versions for custom tool..."
versions=$(mise ls-remote just-test 2>&1)
if [[ ! $versions =~ 1\. ]]; then
	echo "ERROR: Expected versions not found"
	echo "Got: $versions"
	exit 1
fi

# Install using the custom backend
echo "Installing just-test with custom backend..."
mise install just-test@latest

# Verify installation - the binary is still called 'just' even though we installed as 'just-test'
echo "Verifying installation..."
if ! ls "$HOME/.local/share/mise/installs/just-test/"*/just >/dev/null 2>&1; then
	echo "ERROR: just binary not found in just-test installation"
	ls -la "$HOME/.local/share/mise/installs/just-test/"*/ 2>/dev/null || true
	exit 1
fi

# Test execution - need to use 'just' as the binary name
echo "Testing execution..."
version_output=$(mise exec just-test -- just --version 2>&1)
if [[ ! $version_output =~ just ]]; then
	echo "ERROR: Unexpected output from just-test"
	echo "Got: $version_output"
	exit 1
fi

# Clean up
mise uninstall --all just-test

# Test 2: Override with complex backend specification
echo "Testing complex backend specification..."
export MISE_BACKENDS_MYCLI='github:BurntSushi/ripgrep[exe=rg]'

# List versions
echo "Listing versions for mycli..."
versions=$(mise ls-remote mycli 2>&1)
if [[ ! $versions =~ 14\. ]]; then
	echo "ERROR: Expected ripgrep versions not found"
	echo "Got: $versions"
	exit 1
fi

# Install
echo "Installing mycli with override..."
mise install mycli@14.0.0

# Verify the executable name is correct
echo "Verifying executable name..."
if ! mise exec mycli -- rg --version 2>&1 | grep -q "ripgrep"; then
	echo "ERROR: rg executable not working correctly"
	mise exec mycli -- rg --version 2>&1 || true
	exit 1
fi

# Clean up
mise uninstall --all mycli
unset MISE_BACKENDS_MYCLI

echo "Non-registry backend environment variable override test passed!"
