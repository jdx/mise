#!/usr/bin/env bash

# Test filter_bins option for github backend using pandoc.
# We use pandoc because it is a compiled binary and comes with multiple binaries to filter.

if [[ "$(uname -s)" != "Linux" ]]; then
  echo "Skipping Linux-specific test on non-Linux OS"
  exit 0
fi

# Set MISE_EXPERIMENTAL for github backend features
export MISE_EXPERIMENTAL=1

# --- Test Pandoc ---
# Create a mise.toml with filter_bins option for pandoc
# Use a specific asset pattern to ensure we get the right archive for Linux x64
cat > mise.toml <<EOF
[tools]
"github:jgm/pandoc" = { version = "3.1.9", filter_bins = "pandoc", asset_pattern = "pandoc-*-linux-amd64.tar.gz" }
EOF

echo "Content of mise.toml:"
cat mise.toml

mise trust

# Install pandoc (from config)
echo "Attempting to install pandoc..."
mise install

echo "Checking mise ls --json..."
mise ls --json "github:jgm/pandoc"

# Verify installation path contains .mise-bins for pandoc
pandoc_install_path="$(mise where "github:jgm/pandoc@3.1.9")"
pandoc_bin_path="$pandoc_install_path/.mise-bins"

echo "Checking for .mise-bins at: $pandoc_bin_path"
assert_directory_exists "$pandoc_bin_path"

# Verify pandoc is linked in .mise-bins
if [[ -f "$pandoc_bin_path/pandoc" ]]; then
    echo "pandoc binary exists in .mise-bins"
else
    echo "pandoc binary missing from .mise-bins"
    ls -la "$pandoc_install_path"
    exit 1
fi

# Verify other binaries are NOT linked (e.g., pandoc-lua, pandoc-server)
if [[ -f "$pandoc_bin_path/pandoc-lua" ]]; then
    echo "ERROR: pandoc-lua should not exist in .mise-bins (filtering failed)"
    exit 1
fi
if [[ -f "$pandoc_bin_path/pandoc-server" ]]; then
    echo "ERROR: pandoc-server should not exist in .mise-bins (filtering failed)"
    exit 1
fi
echo "Verified other binaries are filtered out."

# Verify tool works via mise x
assert_contains "mise x -- pandoc --version" "pandoc 3.1.9"

# Clean up
rm mise.toml
mise uninstall "github:jgm/pandoc@3.1.9"