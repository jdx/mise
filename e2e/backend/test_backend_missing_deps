#!/usr/bin/env bash

# Test that package manager backends show helpful errors when their dependencies are missing

# Create a PATH that has mise but not package managers
MISE_DIR="${CARGO_TARGET_DIR:-$ROOT/target}/debug"
export PATH="$MISE_DIR:/usr/bin:/bin:/usr/sbin:/sbin"

# Test npm backend
echo "Testing npm backend with missing npm..."
if command -v npm >/dev/null 2>&1; then
	echo "ERROR: npm is found in PATH, test cannot verify missing dependency behavior"
	exit 1
else
	# Test listing versions - should show helpful error
	output=$(mise ls-remote npm:test-package 2>&1 || true)
	if [[ $output == *"npm is required but not found"* ]]; then
		echo "✓ npm backend shows correct error for ls-remote"
	else
		echo "ERROR: Expected error message about missing npm"
		echo "Got: $output"
	fi

	# Check for helpful suggestions
	if [[ $output == *"mise use node@latest"* ]] && [[ $output == *"mise settings npm.bun=true"* ]]; then
		echo "✓ npm backend shows helpful suggestions"
	else
		echo "ERROR: Error message should suggest installing node and mention bun alternative"
		echo "Got: $output"
	fi

	# Test installing - should show helpful error
	output=$(mise install npm:test-package@latest 2>&1 || true)
	if [[ $output == *"npm is required but not found"* ]]; then
		echo "✓ npm backend shows correct error for install"
	else
		echo "ERROR: Expected error message about missing npm on install"
		echo "Got: $output"
	fi
fi

# Test npm backend with bun mode
echo "Testing npm backend with bun mode enabled but bun missing..."
if command -v bun >/dev/null 2>&1; then
	echo "ERROR: bun is found in PATH, test cannot verify missing dependency behavior"
	exit 1
else
	export MISE_NPM_BUN=true
	output=$(mise ls-remote npm:test-package 2>&1 || true)
	if [[ $output == *"bun is required but not found"* ]]; then
		echo "✓ npm backend shows correct error for missing bun"
	else
		echo "ERROR: Expected error message about missing bun"
		echo "Got: $output"
	fi

	if [[ $output == *"mise use bun@latest"* ]]; then
		echo "✓ npm backend shows helpful suggestion for bun"
	else
		echo "ERROR: Error message should suggest installing bun"
		echo "Got: $output"
	fi
	unset MISE_NPM_BUN
fi

# Test cargo backend
echo "Testing cargo backend with missing cargo..."
# Remove cargo from path if it exists
NEW_PATH=""
IFS=':' read -ra PATHS <<<"$PATH"
for p in "${PATHS[@]}"; do
	if [[ ! -x "$p/cargo" ]]; then
		if [[ -z $NEW_PATH ]]; then
			NEW_PATH="$p"
		else
			NEW_PATH="$NEW_PATH:$p"
		fi
	fi
done
export PATH="$NEW_PATH"

if command -v cargo >/dev/null 2>&1; then
	echo "ERROR: cargo is found in PATH, test cannot verify missing dependency behavior"
	exit 1
else
	output=$(mise install cargo:test-crate@latest 2>&1 || true)
	if [[ $output == *"cargo is required but not found"* ]]; then
		echo "✓ cargo backend shows correct error"
	else
		echo "ERROR: cargo backend did not show expected error"
		echo "Got: $output"
	fi
fi

# Test go backend (checking list-remote since it also needs go)
echo "Testing go backend with missing go..."
# Remove go from path if it exists
NEW_PATH=""
IFS=':' read -ra PATHS <<<"$PATH"
for p in "${PATHS[@]}"; do
	if [[ ! -x "$p/go" ]]; then
		if [[ -z $NEW_PATH ]]; then
			NEW_PATH="$p"
		else
			NEW_PATH="$NEW_PATH:$p"
		fi
	fi
done
export PATH="$NEW_PATH"

if command -v go >/dev/null 2>&1; then
	echo "ERROR: go is found in PATH, test cannot verify missing dependency behavior"
	exit 1
else
	output=$(mise ls-remote go:github.com/test/test 2>&1 || true)
	if [[ $output == *"go is required but not found"* ]]; then
		echo "✓ go backend shows correct error"
	else
		echo "ERROR: go backend did not show expected error"
		echo "Got: $output"
	fi
fi

echo "✓ backend dependency error test passed"
