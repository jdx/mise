#!/usr/bin/env bash

# Test mise prepare (mise prep) command

# Test --list with no providers configured
assert_contains "mise prepare --list" "No prepare providers found"

# Create a package-lock.json (npm provider needs to be configured to detect it)
cat >package-lock.json <<'EOF'
{
  "name": "test-project",
  "lockfileVersion": 3,
  "packages": {}
}
EOF

# Still no providers without explicit config
assert_contains "mise prepare --list" "No prepare providers found"

# Configure npm provider explicitly
cat >mise.toml <<'EOF'
[prepare.npm]
EOF

# Now npm provider should be detected
assert_contains "mise prepare --list" "npm"
assert_contains "mise prepare --list" "package-lock.json"
assert_contains "mise prepare --list" "node_modules"

# Test --dry-run shows what would run
assert_contains "mise prepare --dry-run" "npm"

# Test alias works
assert_contains "mise prep --list" "npm"

# Test with custom prepare provider (no .rules. prefix)
cat >mise.toml <<'EOF'
[prepare.npm]

[prepare.codegen]
sources = ["schema.graphql"]
outputs = ["generated/"]
run = "echo codegen"
EOF

# Create source file
touch schema.graphql

assert_contains "mise prepare --list" "codegen"
assert_contains "mise prepare --list" "schema.graphql"

# Test --only flag
assert_contains "mise prepare --dry-run --only codegen" "codegen"
assert_not_contains "mise prepare --dry-run --only codegen" "npm"

# Test --skip flag
assert_not_contains "mise prepare --dry-run --skip npm" "npm install"

# Test disable in config
cat >mise.toml <<'EOF'
[prepare]
disable = ["npm"]

[prepare.npm]

[prepare.codegen]
sources = ["schema.graphql"]
outputs = ["generated/"]
run = "echo codegen"
EOF

assert_not_contains "mise prepare --list" "npm"
assert_contains "mise prepare --list" "codegen"

# Test per-provider auto flag
cat >mise.toml <<'EOF'
[prepare.npm]
auto = true

[prepare.codegen]
auto = false
sources = ["schema.graphql"]
outputs = ["generated/"]
run = "echo codegen"
EOF

# Both should show in list
assert_contains "mise prepare --list" "npm"
assert_contains "mise prepare --list" "codegen"
