#!/usr/bin/env bash

set -e
eval "$(rtx activate bash)"
_rtx_hook

export RTX_EXPERIMENTAL=1
export RTX_GO_DEFAULT_PACKAGES_FILE="$ROOT/e2e/.default-go-packages"

assert_gopath() {
  local expected="$1"
  if [[ "$GOPATH" != "$expected" ]]; then
    echo "Invalid GOPATH: $GOPATH, expected: $expected"
    exit 1
  fi
}

cat >"$RTX_GO_DEFAULT_PACKAGES_FILE" <<EOF
github.com/Dreamacro/clash # allows comments
github.com/jesseduffield/lazygit
EOF

rtx i golang@1.18.10 golang@1.19 && _rtx_hook
assert_gopath "$RTX_DATA_DIR/installs/go/1.19/packages"
cd 18 && _rtx_hook
assert_gopath "$RTX_DATA_DIR/installs/go/1.18.10/packages"
cd .. && _rtx_hook
assert_gopath "$RTX_DATA_DIR/installs/go/1.19/packages"

rm "$RTX_GO_DEFAULT_PACKAGES_FILE"
