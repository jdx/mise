#!/usr/bin/env bash

export MISE_LOCKFILE=1
export MISE_EXPERIMENTAL=1

cat <<EOF >.bun-version
1.1.21
EOF

assert "mise i"
assert_contains "mise x bun -- bun -v" "1.1.21"

require_cmd node
assert_contains 'mise x bun -- bunx cowsay "hello world"' "hello world"

echo "=== Testing multi-platform lockfile generation for Bun ==="
# Test generating lockfile for multiple platforms (single call)
assert_contains "mise lock bun --platform linux-x64,macos-arm64,windows-x64" "Targeting 3 platform(s): linux-x64, macos-arm64, windows-x64"
assert_contains "mise lock bun --platform linux-x64,macos-arm64,windows-x64" "Lockfile updated at"

# Verify the lockfile exists and contains platform-specific data for all 3 platforms
assert "test -f mise.lock" ""
assert_contains "cat mise.lock" "linux-x64"
assert_contains "cat mise.lock" "macos-arm64"
assert_contains "cat mise.lock" "windows-x64"

# Verify URLs are platform-specific for Bun (GitHub releases)
assert_contains "cat mise.lock" "bun-linux-x64.zip"
assert_contains "cat mise.lock" "bun-darwin-aarch64.zip"
assert_contains "cat mise.lock" "bun-windows-x64.zip"

# Verify the basic lockfile structure
assert_contains "cat mise.lock" 'backend = "core:bun"'
assert_contains "cat mise.lock" 'version = "1.1.21"'
assert_contains "cat mise.lock" 'url = "https://github.com/oven-sh/bun/releases'

echo "=== Validating lockfile metadata ==="
# Validate exact sizes and checksums for each platform
echo "Validating exact platform metadata"

# Linux x64 platform validation
assert_contains "cat mise.lock" "size = 34153617"
assert_contains "cat mise.lock" 'checksum = "blake3:1d5cbae518a45a59aa4429708779dde0b465624ecdaea9d6824dcda645edbdcb"'
assert_contains "cat mise.lock" "bun-linux-x64.zip"

# macOS ARM64 platform validation
assert_contains "cat mise.lock" "size = 18244938"
assert_contains "cat mise.lock" 'checksum = "blake3:0dc09c220944a16e0edcaf2ee4cbc9ca4ce40a5a117002bdb491c98fe64173ef"'
assert_contains "cat mise.lock" "bun-darwin-aarch64.zip"

# Windows x64 platform validation
assert_contains "cat mise.lock" "size = 37349456"
assert_contains "cat mise.lock" 'checksum = "blake3:bfc442f36392b59aa616dd58d213296a1275943b6ba549b2dcd8638d44eb06c3"'
assert_contains "cat mise.lock" "bun-windows-x64.zip"
