name: auto-merge-release

on:
  schedule:
    # 10:00 UTC = 4am CST (winter) / 5am CDT (summer)
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  merge:
    if: github.repository == 'jdx/mise'
    runs-on: ubuntu-latest
    steps:
      - name: Merge release into main
        run: |
          PR_NUMBER=$(gh pr list -R jdx/mise --base main --head release --state open --json number --jq '.[0].number // empty')
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR from release to main"
            exit 0
          fi

          BODY=$(gh pr view "$PR_NUMBER" -R jdx/mise --json body --jq '.body // ""')
          TRIMMED_BODY=$(echo "$BODY" | tr -d '[:space:]')
          if [ -z "$TRIMMED_BODY" ]; then
            echo "PR #$PR_NUMBER has no description, never merging"
            exit 0
          fi

          # Parse description for section headers (release-plz groups commits by type)
          # Substantive sections (daily): Features, Bug Fixes, Performance, Security
          # Non-substantive sections (weekly): Refactor, Revert, Documentation, Chore, Registry, Dependency Updates
          SUBSTANTIVE=$(echo "$BODY" | grep -E '^[[:space:]]*###.*(Features|Bug Fixes|Performance|Security)' || true)

          if [ -n "$SUBSTANTIVE" ]; then
            echo "PR #$PR_NUMBER has substantive changes (Features/Bug Fixes/Performance/Security), merging daily"
          else
            CREATED=$(gh pr view "$PR_NUMBER" -R jdx/mise --json createdAt --jq '.createdAt')
            if [ -z "$CREATED" ]; then
              echo "ERROR: Failed to get PR creation date"
              exit 1
            fi

            CREATED_EPOCH=$(date -d "$CREATED" +%s 2>/dev/null)
            if [ -z "$CREATED_EPOCH" ]; then
              echo "ERROR: Failed to parse PR creation date: $CREATED"
              exit 1
            fi

            NOW_EPOCH=$(date +%s)
            DAYS_OLD=$(( (NOW_EPOCH - CREATED_EPOCH) / 86400 ))
            if [ "$DAYS_OLD" -lt 7 ]; then
              echo "PR #$PR_NUMBER only non-substantive changes (docs/chore/registry/deps), $DAYS_OLD days old; waiting until 7 days"
              exit 0
            fi
            echo "PR #$PR_NUMBER only non-substantive changes, 7+ days old, enabling auto-merge"
          fi

          gh pr merge "$PR_NUMBER" -R jdx/mise --squash --auto || {
            echo "Merge failed or PR not ready, will retry tomorrow"
            exit 0
          }
        env:
          GH_TOKEN: ${{ secrets.MISE_GH_TOKEN }}
