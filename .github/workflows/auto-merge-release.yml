name: auto-merge-release

on:
  schedule:
    # 4am Central Standard Time = 10:00 UTC (5am during daylight saving)
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  merge:
    if: github.repository == 'jdx/mise'
    runs-on: ubuntu-latest
    steps:
      - name: Merge release into main
        run: |
          # Check if there's an open PR from release to main
          PR_NUMBER=$(gh pr list --base main --head release --state open --json number --jq '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR from release to main"
            exit 0
          fi

          echo "Found PR #$PR_NUMBER"

          # Enable auto-merge which waits for CI checks to pass
          gh pr merge "$PR_NUMBER" --merge --auto || {
            echo "Merge failed or PR not ready, will retry tomorrow"
            exit 0
          }
        env:
          GH_TOKEN: ${{ secrets.MISE_GH_TOKEN }}
